# ğŸ›ï¸ University Timetable System - Department View Architecture

## âœ… CURRENT IMPLEMENTATION STATUS

### Architecture Principle
**Single Master Timetable + Filtered Views**
- ONE centralized timetable generated by Registrar (FastAPI)
- Multiple department-specific VIEWS (Django filters)
- No data duplication - filter the master timetable

### Layer Separation (CORRECT)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FASTAPI (Compute Layer)                                    â”‚
â”‚  - Timetable generation (CP-SAT, GA, RL)                    â”‚
â”‚  - Hardware optimization (GPU/CPU)                          â”‚
â”‚  - Memory management                                        â”‚
â”‚  - NO business logic                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    Sends generated timetable
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DJANGO (Application Layer)                                 â”‚
â”‚  - Department filtering âœ…                                   â”‚
â”‚  - Cross-enrollment tracking âœ…                              â”‚
â”‚  - Conflict detection âœ…                                     â”‚
â”‚  - User authentication âœ…                                    â”‚
â”‚  - Workflow management âœ…                                    â”‚
â”‚  - API endpoints âœ…                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ IMPLEMENTED FILES

### Django (Application Layer) âœ…
1. **`backend/django/academics/workflow_views.py`**
   - `TimetableWorkflowViewSet` - Workflow management
   - `TimetableVariantViewSet` - Variant management
   - `department_view()` - Department filtering endpoint
   - `_convert_timetable_entries()` - Data conversion

2. **`backend/django/academics/services.py`**
   - `DepartmentViewService.filter_by_department()` - Filter entries
   - `DepartmentViewService.get_department_stats()` - Statistics

3. **`backend/django/academics/urls.py`**
   - `/api/timetable/workflows/` - Workflow endpoints
   - `/api/timetable/variants/` - Variant endpoints
   - `/api/timetable/variants/{id}/department_view/` - Department filter

### Frontend âœ…
1. **`frontend/src/app/admin/timetables/[timetableId]/review/page.tsx`**
   - Variant comparison view
   - Department filter dropdown
   - Timetable grid display
   - Lazy loading of entries

## ğŸ¯ DEPARTMENT VIEW FEATURES (Implemented)

### 1. Registrar View (Super Admin)
- âœ… Full university timetable access
- âœ… All departments visible
- âœ… Conflict detection (84,338 conflicts detected)
- âœ… Quality metrics (25% quality, 5% room utilization)

### 2. Department Head View
- âœ… Filter by department dropdown
- âœ… View only department's courses
- âœ… Cross-enrollment visibility (department_id field)
- âœ… Faculty schedules (faculty_name field)
- âœ… Student lists (batch_name field)

### 3. Department Filtering
```typescript
// Frontend: Department filter dropdown
<select onChange={filterByDepartment}>
  <option value="all">All Departments</option>
  {departments.map(dept => (
    <option value={dept}>{dept}</option>
  ))}
</select>

// Backend: Django endpoint
GET /api/timetable/variants/{id}/department_view/?department_id=CS&job_id={job_id}

// Returns: Filtered entries for CS department only
```

## ğŸ—‘ï¸ REMOVED FILES (Duplicates)

### FastAPI Services (DELETED - Moved to Django)
1. ~~`backend/fastapi/services/department_view_service.py`~~ âŒ
   - Reason: Business logic belongs in Django
   - Replacement: `backend/django/academics/services.py`

2. ~~`backend/fastapi/services/department_preference_service.py`~~ âŒ
   - Reason: User preferences are application logic
   - Replacement: Can be added to Django if needed

3. ~~`backend/fastapi/services/conflict_resolution_service.py`~~ âŒ
   - Reason: Conflict resolution is business logic
   - Replacement: Django can handle this

## ğŸ“Š DATA FLOW

### Timetable Generation (FastAPI)
```
1. Registrar clicks "Generate Timetable"
2. Django sends request to FastAPI
3. FastAPI generates master timetable (8305 entries)
4. FastAPI sends back to Django
5. Django stores in GenerationJob.timetable_data
```

### Department View (Django)
```
1. Department Head opens timetable
2. Frontend loads variants from Django
3. User selects department from dropdown
4. Frontend calls Django department_view endpoint
5. Django filters entries by department_id
6. Returns filtered entries to frontend
7. Frontend displays department-specific timetable
```

## ğŸ” PERMISSION LEVELS (To Be Implemented)

### Current Status
- âœ… Authentication working (Django auth)
- âš ï¸ Role-based access control (RBAC) - TODO
- âš ï¸ Department-level permissions - TODO

### Recommended Implementation
```python
# Django models
class UserProfile(models.Model):
    user = models.OneToOneField(User)
    role = models.CharField(choices=[
        ('registrar', 'Registrar'),
        ('dept_head', 'Department Head'),
        ('coordinator', 'Coordinator'),
        ('faculty', 'Faculty'),
        ('student', 'Student')
    ])
    department = models.ForeignKey(Department, null=True)

# Django permissions
class DepartmentViewPermission(permissions.BasePermission):
    def has_permission(self, request, view):
        if request.user.profile.role == 'registrar':
            return True  # Full access
        if request.user.profile.role == 'dept_head':
            # Only own department
            dept_id = request.query_params.get('department_id')
            return dept_id == request.user.profile.department_id
        return False
```

## ğŸ¨ UI COMPONENTS (Implemented)

### Variant Comparison View âœ…
- Grid of variant cards
- Metrics: Overall score, conflicts, room utilization
- Select variant button
- Click to view detailed timetable

### Department Filter âœ…
- Dropdown with all departments
- "All Departments" option
- Filters timetable grid on selection
- Fetches filtered data from Django

### Timetable Grid âœ…
- Weekly view (Monday-Friday)
- Time slots as rows
- Days as columns
- Course details: code, faculty, room, batch
- Empty slots shown as "-"

## ğŸ“ˆ PERFORMANCE OPTIMIZATIONS (Applied)

### Backend (Django)
- âœ… Aggressive caching (5-10 min)
- âœ… Lazy loading (entries loaded on demand)
- âœ… Result limits (500 entries max)
- âœ… Simplified processing (no UUID lookups)
- âœ… Response compression (GZip)

### Frontend
- âœ… Lazy loading (load entries when clicking variant)
- âœ… In-memory cache (2-10 min TTL)
- âœ… Skeleton loading states
- âœ… Minimal re-renders

## ğŸ› KNOWN ISSUES

### Critical Issues (Fixed)
- âœ… Empty timetable display - Fixed by loading entries on demand
- âœ… Department filter empty - Fixed by removing deduplication
- âœ… Timeout errors - Fixed with caching and lazy loading
- âœ… UUID display - Fixed by using department names

### Current Issues
- âš ï¸ CP-SAT solver producing 84,338 conflicts (25% quality)
- âš ï¸ Room utilization only 5%
- âš ï¸ Need to fix constraint enforcement in FastAPI

## ğŸš€ NEXT STEPS

### Phase 1: Fix Core Issues (Priority)
1. Fix CP-SAT constraint enforcement (FastAPI)
2. Improve room utilization algorithm
3. Reduce conflicts from 84,338 to <100

### Phase 2: Enhance Department Views
1. Add cross-enrollment tracking UI
2. Add faculty schedule view
3. Add conflict alerts dashboard
4. Add resource utilization charts

### Phase 3: Add RBAC
1. Implement role-based permissions
2. Add department-level access control
3. Add change request workflow
4. Add approval system

### Phase 4: Advanced Features
1. Interactive conflict resolution
2. Drag-and-drop rescheduling
3. Predictive conflict detection
4. Mobile apps

## ğŸ“ SUMMARY

**What Works:**
- âœ… Single master timetable generation (FastAPI)
- âœ… Department filtering (Django)
- âœ… Variant comparison (Frontend)
- âœ… Lazy loading (Performance)
- âœ… Caching (Performance)

**What Needs Work:**
- âš ï¸ Constraint enforcement (Quality)
- âš ï¸ Room utilization (Optimization)
- âš ï¸ RBAC (Security)
- âš ï¸ Cross-enrollment UI (Features)

**Architecture:**
- âœ… Correct layer separation (FastAPI = compute, Django = application)
- âœ… Single source of truth (one master timetable)
- âœ… Filtered views (no data duplication)
- âœ… RESTful API design

---

**Last Updated:** 2024-01-27
**Status:** Department filtering implemented and working
**Next Priority:** Fix CP-SAT constraint enforcement
